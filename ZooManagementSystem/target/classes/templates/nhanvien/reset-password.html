<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" lang="vi">

<head>
  <meta charset="UTF-8">
  <title>Đặt lại mật khẩu - Zoo Management</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet" />
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css" rel="stylesheet" />
  <style>
    .strength-checklist li {
      display: flex;
      align-items: center;
      gap: 6px;
    }

    .strength-checklist i {
      width: 18px;
    }

    .progress-sm {
      height: 10px;
      border-radius: 10px;
    }
  </style>
</head>

<body class="bg-light">

<div class="container my-5" style="max-width: 640px;">
  <a href="/nhanvien" class="btn btn-outline-secondary mb-4">
    <i class="fas fa-arrow-left me-2"></i> Quay lại danh sách nhân viên
  </a>

  <h2 class="text-center text-danger mb-4">
    <i class="fas fa-key me-2"></i>Đổi mật khẩu cho nhân viên
  </h2>

  <!-- Thông báo -->
  <div th:if="${success != null || error != null || warning != null}" class="alert alert-dismissible fade show"
       th:classappend="${success} ? 'alert-success' : (error != null ? 'alert-danger' : 'alert-warning')" role="alert">
    <i class="fa-solid fa-circle-info me-2"></i>
    <span th:text="${success ?: error ?: warning}">Thông báo</span>
    <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
  </div>

  <!-- Form -->
  <form th:action="@{/nhanvien/reset-password/{id}(id=${userId})}" method="post"
        class="bg-white p-4 rounded shadow-sm needs-validation" novalidate>

    <!-- Mật khẩu mới -->
    <div class="mb-3">
      <label for="newPassword" class="form-label fw-semibold"><i class="fas fa-lock me-2"></i> Mật khẩu mới</label>
      <div class="input-group">
        <input type="password" name="newPassword" id="newPassword" class="form-control"
               placeholder="Nhập mật khẩu mới" required />
        <button type="button" class="btn btn-outline-secondary" onclick="togglePassword('newPassword')">
          <i class="fa-solid fa-eye"></i>
        </button>
        <div class="invalid-feedback">Mật khẩu phải đủ mạnh (đủ 5 yêu cầu).</div>
      </div>
      <div class="progress mt-2 progress-sm">
        <div id="pwBar" class="progress-bar" role="progressbar" style="width:0%"></div>
      </div>
      <small id="pwLabel" class="form-text text-muted">Độ mạnh: Kém</small>
      <ul class="strength-checklist small mt-2 list-unstyled">
        <li id="rLower" class="text-muted"><i class="bi bi-dot"></i> Có chữ thường</li>
        <li id="rUpper" class="text-muted"><i class="bi bi-dot"></i> Có chữ hoa</li>
        <li id="rDigit" class="text-muted"><i class="bi bi-dot"></i> Có số</li>
        <li id="rSpecial" class="text-muted"><i class="bi bi-dot"></i> Có ký tự đặc biệt</li>
        <li id="rLen" class="text-muted"><i class="bi bi-dot"></i> Độ dài ≥ 8 ký tự</li>
      </ul>
    </div>

    <!-- Xác nhận -->
    <div class="mb-3">
      <label for="confirmPassword" class="form-label fw-semibold"><i class="fas fa-lock me-2"></i> Xác nhận mật khẩu</label>
      <div class="input-group">
        <input type="password" name="confirmPassword" id="confirmPassword" class="form-control"
               placeholder="Nhập lại mật khẩu" required />
        <button type="button" class="btn btn-outline-secondary" onclick="togglePassword('confirmPassword')">
          <i class="fa-solid fa-eye"></i>
        </button>
        <div class="invalid-feedback">Mật khẩu xác nhận không khớp.</div>
      </div>
    </div>

    <!-- Nút -->
    <div class="d-flex justify-content-end mt-4 gap-2">
      <button type="submit" class="btn btn-primary"><i class="fas fa-save me-2"></i> Cập nhật mật khẩu</button>
      <a href="/nhanvien" class="btn btn-secondary"><i class="fas fa-times me-2"></i> Hủy</a>
    </div>
  </form>
</div>

<!-- Scripts -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script>
  function togglePassword(id) {
    const input = document.getElementById(id);
    input.type = input.type === "password" ? "text" : "password";
  }

  const pw = document.getElementById('newPassword');
  const cpw = document.getElementById('confirmPassword');
  const bar = document.getElementById('pwBar');
  const lbl = document.getElementById('pwLabel');

  const rLower = document.getElementById('rLower');
  const rUpper = document.getElementById('rUpper');
  const rDigit = document.getElementById('rDigit');
  const rSpecial = document.getElementById('rSpecial');
  const rLen = document.getElementById('rLen');

  function check(val, regex) { return regex.test(val); }

  function updateStrength() {
    const v = pw.value || '';
    const checks = [
      check(v, /[a-z]/),
      check(v, /[A-Z]/),
      check(v, /\d/),
      check(v, /[^A-Za-z0-9]/),
      v.length >= 8
    ];

    const list = [rLower, rUpper, rDigit, rSpecial, rLen];
    checks.forEach((ok, i) => {
      list[i].classList.toggle('text-success', ok);
      list[i].classList.toggle('text-muted', !ok);
      list[i].querySelector('i').className = ok ? 'bi bi-check-circle-fill text-success' : 'bi bi-dot';
    });

    const score = checks.filter(Boolean).length;
    const colors = ['bg-danger', 'bg-danger', 'bg-warning', 'bg-info', 'bg-success'];
    const labels = ['Kém', 'Kém', 'Trung bình', 'Mạnh', 'Rất mạnh'];
    bar.style.width = (score / 5 * 100) + '%';
    bar.className = 'progress-bar ' + colors[score - 1];
    lbl.textContent = 'Độ mạnh: ' + labels[score - 1];

    pw.setCustomValidity(score < 5 ? "weak" : "");
    cpw.setCustomValidity(cpw.value === pw.value ? '' : 'notmatch');
  }

  pw.addEventListener('input', updateStrength);
  cpw.addEventListener('input', updateStrength);
  updateStrength();

  (() => {
    'use strict';
    const forms = document.querySelectorAll('.needs-validation');
    Array.from(forms).forEach(form => {
      form.addEventListener('submit', event => {
        updateStrength();
        if (!form.checkValidity()) {
          event.preventDefault();
          event.stopPropagation();
        }
        form.classList.add('was-validated');
      }, false);
    });
  })();
</script>

</body>
</html>
