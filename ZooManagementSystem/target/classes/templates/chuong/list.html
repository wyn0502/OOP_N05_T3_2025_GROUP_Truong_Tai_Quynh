<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" lang="vi">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Danh S√°ch Chu·ªìng - Zoo Management</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet" />
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet" />
</head>
<body class="bg-light">
<div class="container my-5">
  <a href="/greeting" class="btn btn-outline-primary mb-4">
    <i class="fas fa-arrow-left me-2"></i> Quay l·∫°i Dashboard
  </a>

  <div class="text-center mb-4">
    <h1 class="display-5 fw-bold"><i class="fas fa-house-damage me-2"></i>Qu·∫£n L√Ω Chu·ªìng</h1>
    <p class="text-muted">Danh s√°ch t·∫•t c·∫£ chu·ªìng ƒë√£ t·∫°o</p>
  </div>

  <!-- Form t√¨m ki·∫øm -->
  <div class="row justify-content-center mb-4">
    <div class="col-md-6">
      <div class="card shadow-sm">
        <div class="card-body">
          <form method="get" action="/chuong" class="d-flex gap-2">
            <div class="flex-grow-1">
              <input type="text" 
                     class="form-control" 
                     name="search" 
                     th:value="${searchValue}"
                     placeholder="Nh·∫≠p m√£ chu·ªìng c·∫ßn t√¨m..." 
                     id="searchInput" />
            </div>
            <button type="submit" class="btn btn-primary">
              <i class="fas fa-search me-1"></i>T√¨m ki·∫øm
            </button>
            <a href="/chuong" class="btn btn-outline-secondary" title="Hi·ªÉn th·ªã t·∫•t c·∫£">
              <i class="fas fa-list"></i>
            </a>
          </form>
        </div>
      </div>
    </div>
  </div>

  <!-- Th√¥ng b√°o l·ªói (n·∫øu c√≥) -->
  <div th:if="${error}" class="alert alert-danger mb-4" th:text="${error}"></div>

  <!-- Th√¥ng b√°o k·∫øt qu·∫£ t√¨m ki·∫øm -->
  <div th:if="${searchResult}" class="alert alert-info text-center mb-4" th:text="${searchResult}"></div>

  <div class="d-flex justify-content-center mb-4 gap-3 flex-wrap">
    <a href="/chuong/them" class="btn btn-success btn-lg shadow-sm">
      <i class="fas fa-plus me-2"></i> Th√™m chu·ªìng m·ªõi
    </a>
    <button type="button" onclick="refreshData()" class="btn btn-outline-danger btn-lg shadow-sm">
      <i class="fas fa-sync-alt me-2"></i> L√†m m·ªõi
    </button>
  </div>

  <div class="table-responsive shadow-sm rounded">
    <table th:if="${not #lists.isEmpty(danhSach)}" class="table table-bordered table-hover align-middle text-center bg-white">
      <thead class="table-success">
        <tr>
          <th>M√£ chu·ªìng</th>
          <th>T√™n khu v·ª±c</th>
          <th>S·ª©c ch·ª©a t·ªëi ƒëa</th>
          <th>S·ªë l∆∞·ª£ng hi·ªán t·∫°i</th>
          <th>Tr·∫°ng th√°i</th>
          <th>H√†nh ƒë·ªông</th>
        </tr>
      </thead>
      <tbody>
        <tr th:each="c : ${danhSach}">
          <td>
            <span th:text="${c.maChuong}" class="badge bg-primary">V001</span>
          </td>
          <td th:text="${c.tenKhuVuc}">Khu A</td>
          <td th:text="${c.sucChuaToiDa}">20</td>
          <td>
            <span th:text="${c.soLuongHienTai}" 
                  th:classappend="${c.soLuongHienTai >= c.sucChuaToiDa} ? 'text-danger fw-bold' : 
                                  (${c.soLuongHienTai > c.sucChuaToiDa * 0.8} ? 'text-warning fw-bold' : 'text-success')">5</span>
          </td>
          <td>
            <span th:if="${c.soLuongHienTai == 0}" class="badge bg-secondary">Tr·ªëng</span>
            <span th:if="${c.soLuongHienTai > 0 and c.soLuongHienTai < c.sucChuaToiDa}" class="badge bg-success">C√≥ ch·ªó</span>
            <span th:if="${c.soLuongHienTai >= c.sucChuaToiDa}" class="badge bg-danger">ƒê·∫ßy</span>
          </td>
          <td>
            <div class="btn-group btn-group-sm" role="group">
              <a th:href="@{'/chuong/sua/' + ${c.maChuong}}" class="btn btn-warning" title="S·ª≠a">
                <i class="fas fa-edit"></i>
              </a>
              <a th:href="@{'/chuong/xoa/' + ${c.maChuong}}" class="btn btn-danger" title="X√≥a"
                 onclick="return confirmDelete(event)" th:data-ma-chuong="${c.maChuong}">
                <i class="fas fa-trash-alt"></i>
              </a>
            </div>
          </td>
        </tr>
      </tbody>
    </table>
    
    <div th:if="${#lists.isEmpty(danhSach)}" class="text-center p-5 bg-white rounded shadow-sm">
      <i class="fas fa-house-damage display-1 text-muted mb-3"></i>
      <h4 class="text-muted" th:text="${searchValue != null and !searchValue.isEmpty()} ? 'Kh√¥ng t√¨m th·∫•y k·∫øt qu·∫£' : 'Ch∆∞a c√≥ chu·ªìng n√†o'">Ch∆∞a c√≥ chu·ªìng n√†o</h4>
      <p th:text="${searchValue != null and !searchValue.isEmpty()} ? 'Th·ª≠ t√¨m ki·∫øm v·ªõi t·ª´ kh√≥a kh√°c' : 'H√£y th√™m chu·ªìng ƒë·∫ßu ti√™n ƒë·ªÉ b·∫Øt ƒë·∫ßu qu·∫£n l√Ω.'">H√£y th√™m chu·ªìng ƒë·∫ßu ti√™n ƒë·ªÉ b·∫Øt ƒë·∫ßu qu·∫£n l√Ω.</p>
    </div>
  </div>
</div>

<!-- Loading Modal -->
<div class="modal fade" id="loadingModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-sm modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-body text-center">
        <div class="spinner-border text-primary" role="status">
          <span class="visually-hidden">Loading...</span>
        </div>
        <p class="mt-2 mb-0">ƒêang ki·ªÉm tra...</p>
      </div>
    </div>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script>
  function refreshData() {
    const btn = event.target.closest('button');
    if (!btn) return;
    btn.disabled = true;
    btn.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>ƒêang t·∫£i...';
    setTimeout(() => location.reload(), 800);
  }

  function confirmDelete(event) {
    event.preventDefault();
    const url = event.target.closest('a').href;
    const maChuong = url.split('/').pop();
    
    // Hi·ªÉn th·ªã loading modal
    const loadingModal = new bootstrap.Modal(document.getElementById('loadingModal'));
    loadingModal.show();
    
    // G·ªçi API ki·ªÉm tra tr∆∞·ªõc
    fetch(`/chuong/kiem-tra/${maChuong}`)
        .then(response => response.json())
        .then(data => {
            loadingModal.hide();
            
            if (data.coDongVat) {
                // T·∫°o th√¥ng b√°o chi ti·∫øt
                const animalList = data.tenDongVat.join('\n‚Ä¢ ');
                const message = `‚ö†Ô∏è KH√îNG TH·ªÇ X√ìA CHU·ªíNG ${maChuong}\n\n` +
                               `üìä Th·ªëng k√™:\n` +
                               `‚Ä¢ S·ªë l∆∞·ª£ng ƒë·ªông v·∫≠t: ${data.soDongVat} con\n\n` +
                               `üêæ Danh s√°ch ƒë·ªông v·∫≠t:\n‚Ä¢ ${animalList}\n\n` +
                               `üí° H∆∞·ªõng d·∫´n:\n` +
                               `1. Di chuy·ªÉn ƒë·ªông v·∫≠t sang chu·ªìng kh√°c\n` +
                               `2. Ho·∫∑c x√≥a ƒë·ªông v·∫≠t tr∆∞·ªõc\n` +
                               `3. Sau ƒë√≥ m·ªõi c√≥ th·ªÉ x√≥a chu·ªìng n√†y\n\n` +
                               `üîí L√Ω do: B·∫£o ƒë·∫£m t√≠nh to√†n v·∫πn d·ªØ li·ªáu`;
                
                alert(message);
            } else {
                const confirmMessage = `üóëÔ∏è X√ÅC NH·∫¨N X√ìA CHU·ªíNG\n\n` +
                                     `M√£ chu·ªìng: ${maChuong}\n` +
                                     `Tr·∫°ng th√°i: Chu·ªìng tr·ªëng\n\n` +
                                     `‚ö†Ô∏è H√†nh ƒë·ªông n√†y kh√¥ng th·ªÉ ho√†n t√°c!\n` +
                                     `B·∫°n c√≥ ch·∫Øc ch·∫Øn mu·ªën x√≥a kh√¥ng?`;
                
                if (confirm(confirmMessage)) {
                    // Hi·ªÉn th·ªã th√¥ng b√°o ƒëang x√≥a
                    const deleteBtn = event.target.closest('a');
                    deleteBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i>';
                    deleteBtn.classList.add('disabled');
                    
                    window.location.href = url;
                }
            }
        })
        .catch(error => {
            loadingModal.hide();
            console.error('L·ªói ki·ªÉm tra:', error);
            
            // Fallback n·∫øu API l·ªói
            if (confirm(`Kh√¥ng th·ªÉ ki·ªÉm tra tr·∫°ng th√°i chu·ªìng ${maChuong}.\n\nB·∫°n v·∫´n mu·ªën ti·∫øp t·ª•c x√≥a?`)) {
                window.location.href = url;
            }
        });
    
    return false;
  }

  // Focus v√†o √¥ t√¨m ki·∫øm khi t·∫£i trang
  document.addEventListener('DOMContentLoaded', function() {
    const searchInput = document.getElementById('searchInput');
    if (searchInput && !searchInput.value) {
      searchInput.focus();
    }

    // Hi·ªÉn th·ªã th√¥ng b√°o th√†nh c√¥ng n·∫øu c√≥
    const urlParams = new URLSearchParams(window.location.search);
    if (urlParams.has('deleted')) {
      const alert = document.createElement('div');
      alert.className = 'alert alert-success alert-dismissible fade show';
      alert.innerHTML = `
        <i class="fas fa-check-circle me-2"></i>
        X√≥a chu·ªìng th√†nh c√¥ng!
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
      `;
      document.querySelector('.container').insertBefore(alert, document.querySelector('.text-center'));
      
      // T·ª± ƒë·ªông ·∫©n sau 5 gi√¢y
      setTimeout(() => {
        alert.remove();
      }, 5000);
    }
  });

  // Th√™m hi·ªáu ·ª©ng hover cho c√°c h√†ng
  document.querySelectorAll('tbody tr').forEach(row => {
    row.addEventListener('mouseenter', function() {
      this.style.backgroundColor = '#f8f9fa';
    });
    
    row.addEventListener('mouseleave', function() {
      this.style.backgroundColor = '';
    });
  });
</script>
</body>
</html>
