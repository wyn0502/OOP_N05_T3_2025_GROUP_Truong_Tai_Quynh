<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" lang="vi">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Thêm Loại Vé Mới</title>

  <!-- Bootstrap 5 CSS -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet" />
  <!-- FontAwesome Icons -->
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet" />
</head>
<body class="bg-light">

  <div class="container my-5" style="max-width: 500px;">
    <h2 class="text-center text-primary mb-4">
      <i class="fas fa-plus-circle me-2"></i>Thêm Loại Vé Mới
    </h2>

    <!-- Alert thông báo chung -->
    <div id="alertBox" class="alert alert-danger d-none" role="alert">
      <i class="fas fa-exclamation-triangle me-2"></i><span id="alertMessage"></span>
    </div>

    <form th:action="@{/giave/add}" th:object="${ve}" method="post" id="addVeForm" novalidate>
      <!-- Loại vé -->
      <div class="mb-3">
        <label for="loaiVe" class="form-label fw-semibold">
          <i class="fas fa-tag me-2"></i>Loại Vé
        </label>
        <div class="input-group">
          <input type="text" id="loaiVe" th:field="*{loaiVe}" class="form-control" placeholder="Nhập loại vé..." autocomplete="off" required />
          <button class="btn btn-outline-secondary dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false">
            Chọn nhanh
          </button>
          <ul class="dropdown-menu">
            <li><a class="dropdown-item" href="#" onclick="setLoaiVe('Vé Trẻ Em');return false;">Vé Trẻ Em</a></li>
            <li><a class="dropdown-item" href="#" onclick="setLoaiVe('Vé Sinh Viên');return false;">Vé Sinh Viên</a></li>
            <li><a class="dropdown-item" href="#" onclick="setLoaiVe('Vé Người Lớn');return false;">Vé Người Lớn</a></li>
            <li><a class="dropdown-item" href="#" onclick="setLoaiVe('Vé Người Cao Tuổi');return false;">Vé Người Cao Tuổi</a></li>
          </ul>
        </div>
        <div class="invalid-feedback">Vui lòng nhập loại vé!</div>
      </div>

      <!-- Giá vé -->
      <div class="mb-3">
        <label for="giaCoBan" class="form-label fw-semibold">
          <i class="fas fa-dollar-sign me-2"></i>Giá Vé (VNĐ)
        </label>
        <input type="text"
               id="giaCoBan"
               th:name="giaCoBan"
               th:value="${ve.giaCoBan != null ? ve.giaCoBan.intValue() : ''}"
               class="form-control"
               placeholder="Nhập giá vé (VNĐ)"
               pattern="[0-9]+"
               inputmode="numeric"
               required />
        <div class="invalid-feedback">Vui lòng nhập giá vé hợp lệ (chỉ số và ≥ 1000)!</div>
      </div>

      <!-- Lý do giảm giá -->
      <div class="mb-3">
        <label for="lyDoGiamGia" class="form-label fw-semibold">
          <i class="fas fa-info-circle me-2"></i>Lý do giảm giá
        </label>
        <input type="text" id="lyDoGiamGia" th:field="*{lyDoGiamGia}" class="form-control" placeholder="Nhập lý do (nếu có)" />
      </div>

      <!-- Phần trăm giảm giá -->
      <div class="mb-3">
        <label for="phanTramGiamGia" class="form-label fw-semibold">
          <i class="fas fa-percent me-2"></i>Phần trăm giảm giá (%)
        </label>
        <input type="text"
               id="phanTramGiamGia"
               th:name="phanTramGiamGia"
               th:value="${ve.phanTramGiamGia != null ? ve.phanTramGiamGia.intValue() : ''}"
               class="form-control"
               placeholder="Nhập phần trăm giảm giá"
               pattern="[0-9]+"
               inputmode="decimal" />
        <div class="invalid-feedback">Phần trăm giảm giá phải là số từ 0 đến 100!</div>
      </div>

      <button type="submit" class="btn btn-primary w-100 fw-semibold" id="submitBtn" disabled>
        <i class="fas fa-save me-2"></i>Lưu Lại
      </button>
    </form>

    <div class="text-center mt-4">
      <a href="/giave" class="text-primary text-decoration-none fw-semibold">
        <i class="fas fa-arrow-left me-2"></i>Quay lại danh sách
      </a>
    </div>
  </div>

  <!-- Bootstrap 5 JS Bundle -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

  <script>
    function setLoaiVe(val) {
      const loaiVeInput = document.getElementById('loaiVe');
      loaiVeInput.value = val;
      loaiVeInput.classList.remove('is-invalid');
      loaiVeInput.focus();
      if (typeof updateSubmitButton === "function") updateSubmitButton();
    }

    const form = document.getElementById('addVeForm');
    const loaiVeInput = document.getElementById('loaiVe');
    const giaCoBanInput = document.getElementById('giaCoBan');
    const phanTramGiamGiaInput = document.getElementById('phanTramGiamGia');
    const submitBtn = document.getElementById('submitBtn');
    const alertBox = document.getElementById('alertBox');
    const alertMessage = document.getElementById('alertMessage');

    function showAlert(message, type = 'danger') {
      alertBox.className = `alert alert-${type}`;
      alertMessage.textContent = message;
      alertBox.classList.remove('d-none');
      setTimeout(() => {
        alertBox.classList.add('d-none');
      }, 4000);
    }

    function showError(field, message) {
      field.classList.add('is-invalid');
      const feedback = field.nextElementSibling;
      if(feedback) feedback.textContent = message;
    }

    function clearError(field) {
      field.classList.remove('is-invalid');
    }

    function validateField(field) {
      clearError(field);
      const val = field.value.trim();

      switch(field.id) {
        case 'loaiVe':
          if(!val) showError(field, 'Vui lòng nhập loại vé!');
          break;

        case 'giaCoBan':
          if(!val) {
            showError(field, 'Vui lòng nhập giá vé!');
          } else if(!/^\d+$/.test(val)) {
            showError(field, 'Giá vé chỉ được nhập số!');
          } else if(parseInt(val) < 1000) {
            showError(field, 'Giá vé phải ít nhất 1,000 VNĐ!');
          }
          break;

        case 'phanTramGiamGia':
          if(val) {
            const num = parseFloat(val);
            if(isNaN(num) || num < 0 || num > 100) {
              showError(field, 'Phần trăm giảm giá phải từ 0 đến 100!');
            }
          }
          break;
      }
    }

    function updateSubmitButton() {
      const noErrors = ![loaiVeInput, giaCoBanInput, phanTramGiamGiaInput].some(f => f.classList.contains('is-invalid'));
      const allRequiredFilled = loaiVeInput.value.trim() !== '' && giaCoBanInput.value.trim() !== '';
      submitBtn.disabled = !(noErrors && allRequiredFilled);
    }

    loaiVeInput.addEventListener('input', e => {
      validateField(e.target);
      updateSubmitButton();
    });

    giaCoBanInput.addEventListener('input', e => {
      e.target.value = e.target.value.replace(/[^\d]/g, '');
      validateField(e.target);
      updateSubmitButton();
    });

    phanTramGiamGiaInput.addEventListener('input', e => {
      e.target.value = e.target.value.replace(/[^\d.]/g, '');
      const parts = e.target.value.split('.');
      if(parts.length > 2){
        e.target.value = parts[0] + '.' + parts.slice(1).join('');
      }
      validateField(e.target);
      updateSubmitButton();
    });

    form.addEventListener('submit', e => {
      e.preventDefault();
      [loaiVeInput, giaCoBanInput, phanTramGiamGiaInput].forEach(validateField);

      const hasErrors = [...form.elements].some(el => el.classList && el.classList.contains('is-invalid'));
      if(hasErrors){
        showAlert('Vui lòng sửa các lỗi trước khi gửi.', 'danger');
        return false;
      }

      showAlert('Đang lưu dữ liệu...', 'success');
      form.submit();
    });

    updateSubmitButton();
  </script>

</body>
</html>
